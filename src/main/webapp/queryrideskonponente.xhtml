<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets">

	<h:form id="queryForm">

		<p:panel header="Search Available Rides"
			styleClass="query-panel-margin">
			<h:panelGrid columns="2" cellpadding="10">
				<h:outputLabel value="Depart City:" styleClass="form-label" />
				<p:selectOneMenu id="originCombo"
					value="#{queryrides.selectedOrigin}" styleClass="combo-box">
					<f:selectItem itemLabel="Select City..." itemValue="" />
					<f:selectItems value="#{queryrides.departCities}" />
					<p:ajax listener="#{queryrides.onOriginChange}"
						update="destinationCombo ridesTable messages" />
				</p:selectOneMenu>

				<h:outputLabel value="Arrival City:" styleClass="form-label" />
				<p:selectOneMenu id="destinationCombo"
					value="#{queryrides.selectedDestination}" styleClass="combo-box">
					<f:selectItem itemLabel="Select City..." itemValue="" />
					<f:selectItems value="#{queryrides.destinationCities}" />
					<p:ajax update="ridesTable messages" />
				</p:selectOneMenu>

				<h:outputLabel value="Ride Date:" styleClass="form-label" />
				<p:calendar id="rideDate" value="#{queryrides.selectedDate}"
					navigator="true" mode="popup" showOn="button" pattern="dd/MM/yyyy"
					mindate="#{queryrides.minDate}">
					<p:ajax event="dateSelect" listener="#{queryrides.onDateSelect}"
						update="ridesTable" />
				</p:calendar>

			</h:panelGrid>

			<br />
			<p:commandButton value="Find Rides"
				action="#{queryrides.searchRides}" icon="pi pi-search"
				styleClass="ui-button-primary btn-wide" update="ridesTable" />
		</p:panel>

		<p:dataTable id="ridesTable" value="#{queryrides.foundRides}"
			var="ride" emptyMessage="No rides found for these criteria."
			border="1" paginator="true" rows="5" paginatorPosition="bottom"
			styleClass="rides-table">

			<f:facet name="header">Available Rides List</f:facet>
			<p:column headerText="Date">
				<h:outputText value="#{ride.date}">
					<f:convertDateTime pattern="dd/MM/yyyy" />
				</h:outputText>
			</p:column>
			<p:column headerText="From">
				<h:outputText value="#{ride.from}" />
			</p:column>
			<p:column headerText="To">
				<h:outputText value="#{ride.to}" />
			</p:column>
			<p:column headerText="Seats">
				<h:outputText value="#{ride.nPlaces}" />
			</p:column>
			<p:column headerText="Price">
				<h:outputText value="#{ride.price} â‚¬" />
			</p:column>

			<p:column headerText="Availability"
				style="width: 120px; text-align: center;">

				<h:outputText value="FULL" rendered="#{ride.rideFull}"
					style="color: red; font-weight: bold; font-weight: 900;" />

				<p:commandButton value="Reservar"
					action="#{queryrides.erreserbatu(ride)}"
					update=":queryForm:ridesTable :queryForm:messages"
					icon="pi pi-check" styleClass="ui-button-success"
					rendered="#{user.traveler and not ride.rideFull}" />

				<h:outputText value="Available"
					rendered="#{user.driver and not ride.rideFull}"
					style="color: green; font-weight: bold;" />

			</p:column>
			
			<p:column headerText="Driver">
            <p:commandLink value="#{ride.driver.name}" 
                           actionListener="#{queryRides.loadDriverInfo(ride.driver)}"
                           update=":mainForm:driverDialog"
                           oncomplete="PF('driverDialog').show()"
                           style="font-weight: bold; text-decoration: underline; color: #2196F3;"
                           title="View ratings" />
        </p:column>

		</p:dataTable>
		<p:dialog id="driverDialog" widgetVar="driverDialog" header="Driver Profile" 
                  modal="true" showEffect="fade" hideEffect="fade" resizable="false" width="500">
            
            <p:outputPanel id="driverDetail" style="text-align:center;">
                <h:panelGroup rendered="#{not empty queryRides.selectedDriver}">
                    
                    <div style="margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                        <h2 style="margin-top:0">#{queryRides.selectedDriver.name}</h2>
                        <h:outputText value="#{queryRides.selectedDriver.email}" style="color: grey;"/>
                    </div>

                    <p:dataTable value="#{queryRides.driverRatings}" var="rating" 
                                 emptyMessage="This driver has no ratings yet."
                                 scrollable="true" scrollHeight="200">
                        
                        <p:column headerText="Traveller" width="100">
                            <h:outputText value="#{rating.traveller.name}" />
                        </p:column>

                        <p:column headerText="Rating" width="80">
                            <p:rating value="#{rating.stars}" readonly="true" />
                        </p:column>
                        
                        <p:column headerText="Comment">
                            <h:outputText value="#{rating.description}" />
                        </p:column>
                        
                    </p:dataTable>
                    
                </h:panelGroup>
            </p:outputPanel>
        </p:dialog>
		<h:messages id="messages" globalOnly="true"
			styleClass="global-messages" />

	</h:form>
</ui:composition>