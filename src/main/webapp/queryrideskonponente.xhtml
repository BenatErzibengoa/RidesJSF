<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets">

	<h:form id="queryForm">

		<p:growl id="growl" showDetail="true" life="4000" />

		<p:panel header="Search Available Rides"
			styleClass="query-panel-margin">
			<h:panelGrid columns="2" cellpadding="10">
				<h:outputLabel value="Depart City:" styleClass="form-label" />
				
				<p:selectOneMenu id="originCombo"
					value="#{queryrides.selectedOrigin}" styleClass="combo-box">
					<f:selectItem itemLabel="Select City..." itemValue="" />
					<f:selectItems value="#{queryrides.departCities}" />
					<p:ajax listener="#{queryrides.onOriginChange}"
						update="destinationCombo ridesTable growl" />
				</p:selectOneMenu>

				<h:outputLabel value="Arrival City:" styleClass="form-label" />
				
				<p:selectOneMenu id="destinationCombo"
					value="#{queryrides.selectedDestination}" styleClass="combo-box">
					<f:selectItem itemLabel="Select City..." itemValue="" />
					<f:selectItems value="#{queryrides.destinationCities}" />
					<p:ajax update="ridesTable growl" />
				</p:selectOneMenu>

				<h:outputLabel value="Ride Date:" styleClass="form-label" />
				<p:calendar id="rideDate" value="#{queryrides.selectedDate}"
					navigator="true" mode="popup" showOn="button" pattern="dd/MM/yyyy"
					mindate="#{queryrides.minDate}">
					<p:ajax event="dateSelect" listener="#{queryrides.onDateSelect}"
						update="ridesTable" />
				</p:calendar>

			</h:panelGrid>

			<br />
			<p:commandButton value="Find Rides"
				action="#{queryrides.searchRides}" icon="pi pi-search"
				styleClass="ui-button-primary btn-wide" 
				update="ridesTable growl" />
		</p:panel>

		<p:dataTable id="ridesTable" value="#{queryrides.foundRides}"
			var="ride" emptyMessage="No rides found for these criteria."
			border="1" paginator="true" rows="5" paginatorPosition="bottom"
			styleClass="rides-table">

			<f:facet name="header">Available Rides List</f:facet>
			<p:column headerText="Date">
				<h:outputText value="#{ride.date}">
					<f:convertDateTime pattern="dd/MM/yyyy" />
				</h:outputText>
			</p:column>
			<p:column headerText="From">
				<h:outputText value="#{ride.from}" />
			</p:column>
			<p:column headerText="To">
				<h:outputText value="#{ride.to}" />
			</p:column>
			<p:column headerText="Seats">
				<h:outputText value="#{ride.nPlaces}" />
			</p:column>
			<p:column headerText="Price">
				<h:outputText value="#{ride.price} â‚¬" />
			</p:column>

			<p:column headerText="Availability"
				style="width: 120px; text-align: center;">
				
				<h:outputText value="Booked" 
        rendered="#{user.traveler and (queryrides.isRideBookedByCurrentUser(ride))}"
        style="color: #2196F3; font-weight: bold; text-transform: uppercase;" />

				<h:outputText value="FULL"
				    rendered="#{ride.rideFull and not (queryrides.isRideBookedByCurrentUser(ride))}"
				    style="color: red; font-weight: bold;" />

				<p:commandButton value="Book"
					action="#{queryrides.erreserbatu(ride)}"
					update=":queryForm:ridesTable :queryForm:growl"
					icon="pi pi-check" styleClass="ui-button-success"
					rendered="#{user.traveler and not ride.rideFull and not (queryrides.isRideBookedByCurrentUser(ride))}" />

				<h:outputText value="Available"
					rendered="#{user.driver and not ride.rideFull}"
					style="color: green; font-weight: bold;" />

			</p:column>

			<p:column headerText="Driver">
				<p:commandLink value="#{ride.driver.name}"
					actionListener="#{queryrides.loadDriverInfo(ride.driver)}"
					update=":queryForm:driverDialog"
					oncomplete="PF('driverDialog').show()"
					style="font-weight: bold; text-decoration: underline; color: #2196F3;"
					title="View ratings" />
			</p:column>

			<p:column headerText="Map">
				<p:commandButton value="See route" icon="pi pi-map"
					actionListener="#{queryrides.setSelectedRideForMap(ride)}"
					update=":queryForm:mapDialog" oncomplete="PF('mapDialog').show()"
					styleClass="ui-button-info" />
			</p:column>

		</p:dataTable>
		
		<p:dialog id="driverDialog" widgetVar="driverDialog" modal="true"
			showEffect="fade" hideEffect="fade" resizable="false" width="800">

			<p:outputPanel id="driverDetail" style="text-align:center;">
				<h:panelGroup rendered="#{not empty queryrides.selectedDriver}">

					<div style="margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
						<h2 style="margin-top: 0">#{queryrides.selectedDriver.name} -
							#{queryrides.getAverageRating()} / 5</h2>
						<h:outputText value="#{queryrides.selectedDriver.email}"
							style="color: grey;" />
					</div>

					<p:dataTable value="#{queryrides.driverRatings}" var="rating"
						emptyMessage="This driver has no ratings yet." scrollable="true"
						scrollHeight="200">

						<p:column headerText="Traveller" width="200">
							<h:outputText value="#{rating.traveller.name}" />
						</p:column>

						<p:column headerText="Rating" width="200">
							<p:rating value="#{rating.stars}" readonly="true" />
						</p:column>

						<p:column headerText="Comment">
							<h:outputText value="#{rating.description}" />
						</p:column>

					</p:dataTable>

				</h:panelGroup>
			</p:outputPanel>
		</p:dialog>

		<p:dialog id="mapDialog" header="Route Preview" widgetVar="mapDialog"
			modal="true" width="900" height="600" resizable="false"
			closable="true">

			<h:panelGroup id="mapContainer">
				<iframe src="#{queryrides.googleMapsUrl()}" width="850" height="500"
					style="border: 0;"> </iframe>
			</h:panelGroup>

		</p:dialog>

		</h:form>
</ui:composition>